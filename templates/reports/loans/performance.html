{% extends "reports/base.html" %}

{% block title %}Loan Performance Report{% endblock %}

{% block extra_head %}
<!-- Optional: include additional CSS for this page -->
<style>
    .filter-row {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Loan Performance Report</h2>

    <!-- Filters -->
    <div class="row filter-row">
        <div class="col-md-3">
            <input type="date" id="startDate" class="form-control" placeholder="Start Date">
        </div>
        <div class="col-md-3">
            <input type="date" id="endDate" class="form-control" placeholder="End Date">
        </div>
        <div class="col-md-3">
            <select id="statusFilter" class="form-select">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="disbursed">Disbursed</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="filterLoans()">Filter</button>
        </div>
    </div>

    <!-- Loans Table -->
    <div class="table-responsive">
        <table class="table table-striped" id="loansTable">
            <thead class="table-dark">
                <tr>
                    <th>Client</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Application Date</th>
                    <th>Approved Date</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in loans %}
                <tr data-status="{{ loan.status }}" data-date="{{ loan.application_date }}">
                    <td>{{ loan.client_account }}</td>
                    <td>{{ loan.amount }}</td>
                    <td>{{ loan.status|capfirst }}</td>
                    <td>{{ loan.application_date }}</td>
                    <td>{{ loan.approved_date }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No loans found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Export Buttons -->
    <div class="mt-3">
        <a href="{% url 'reports:export_loans_csv' %}" class="btn btn-success">Export CSV</a>
        <!-- If PDF export is available -->
        <a href="{% url 'reports:export_summary_pdf' %}" class="btn btn-danger">Export PDF</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterLoans() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const status = document.getElementById('statusFilter').value;

    const rows = document.querySelectorAll('#loansTable tbody tr');

    rows.forEach(row => {
        const rowDate = row.dataset.date;
        const rowStatus = row.dataset.status;

        let show = true;

        if (status && rowStatus !== status) {
            show = false;
        }

        if (start && rowDate < start) show = false;
        if (end && rowDate > end) show = false;

        row.style.display = show ? '' : 'none';
    });
}
</script>
{% endblock %}
