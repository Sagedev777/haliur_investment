{% extends "reports/base.html" %}

{% block title %}Loan Performance Report{% endblock %}
{% block page_title %}Loan Performance{% endblock %}
{% block page_subtitle %}Performance analysis of loan portfolio{% endblock %}

{% block extra_css %}
<style>
    .filter-row {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'reports:export_loans_csv' %}" class="btn btn-success btn-sm">
        <i class="fas fa-file-csv me-1"></i> Export CSV
    </a>
    <a href="{% url 'reports:export_summary_pdf' %}" class="btn btn-danger btn-sm">
        <i class="fas fa-file-pdf me-1"></i> Export PDF
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Filters -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label text-muted small">Start Date</label>
                    <input type="date" id="startDate" class="form-control" placeholder="Start Date">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small">End Date</label>
                    <input type="date" id="endDate" class="form-control" placeholder="End Date">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small">Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="disbursed">Disbursed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="filterLoans()">
                        <i class="fas fa-filter me-2"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loans Table -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="loansTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Client</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Application Date</th>
                            <th>Approved Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loan in loans %}
                        <tr data-status="{{ loan.status }}" data-date="{{ loan.application_date }}">
                            <td class="ps-4 fw-semibold">{{ loan.client_account }}</td>
                            <td>{{ loan.amount }}</td>
                            <td>
                                <span
                                    class="badge {% if loan.status == 'APPROVED' %}bg-success{% elif loan.status == 'PENDING' %}bg-warning{% elif loan.status == 'REJECTED' %}bg-danger{% else %}bg-primary{% endif %} bg-opacity-10 text-dark border border-opacity-25">
                                    {{ loan.status|capfirst }}
                                </span>
                            </td>
                            <td>{{ loan.application_date }}</td>
                            <td>{{ loan.approved_date|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">No loans found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function filterLoans() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const status = document.getElementById('statusFilter').value;

        const rows = document.querySelectorAll('#loansTable tbody tr');

        rows.forEach(row => {
            const rowDate = row.dataset.date;
            const rowStatus = row.dataset.status;

            let show = true;

            if (status && rowStatus !== status) {
                show = false;
            }

            if (start && rowDate < start) show = false;
            if (end && rowDate > end) show = false;

            row.style.display = show ? '' : 'none';
        });
    }
</script>
{% endblock %}