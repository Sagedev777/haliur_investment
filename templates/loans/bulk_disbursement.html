<!-- loans/templates/loans/bulk_disbursement.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Loan Disbursement{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">
                <i class="fas fa-money-check-alt"></i> Bulk Loan Disbursement
            </h4>
        </div>
        
        <div class="card-body">
            <!-- Instructions -->
            <div class="alert alert-warning mb-4">
                <h5><i class="fas fa-exclamation-triangle"></i> Important Information</h5>
                <ul class="mb-0">
                    <li>Only <strong>APPROVED</strong> loans can be disbursed</li>
                    <li>Disbursing a loan will transfer funds to the client's account</li>
                    <li>This action cannot be undone</li>
                    <li>Ensure all documentation is complete before disbursement</li>
                </ul>
            </div>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="bulkDisbursementTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="select-tab" data-bs-toggle="tab" data-bs-target="#select" type="button">
                        <i class="fas fa-list-check"></i> Select Loans
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
                        <i class="fas fa-upload"></i> Upload CSV
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template" type="button">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="bulkDisbursementTabsContent">
                
                <!-- Select Loans Tab -->
                <div class="tab-pane fade show active" id="select" role="tabpanel">
                    <form method="POST" action="{% url 'loans:process_bulk_disbursement' %}">
                        {% csrf_token %}
                        
                        <!-- Disbursement Details -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <strong>Disbursement Date</strong>
                                </label>
                                <input type="date" class="form-control" name="disbursement_date" 
                                       value="{{ today|date:'Y-m-d' }}" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <strong>Disbursement Method</strong>
                                </label>
                                <select class="form-select" name="disbursement_method" required>
                                    <option value="CASH">Cash</option>
                                    <option value="BANK_TRANSFER">Bank Transfer</option>
                                    <option value="MOBILE_MONEY">Mobile Money</option>
                                    <option value="CHEQUE">Cheque</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <strong>Disbursed By</strong>
                                </label>
                                <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
                                <input type="hidden" name="disbursed_by" value="{{ user.id }}">
                            </div>
                        </div>
                        
                        <!-- Approved Loans Table -->
                        <div class="table-responsive mb-4">
                            <table class="table table-hover table-striped">
                                <thead class="table-primary">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                                        </th>
                                        <th>Application #</th>
                                        <th>Client</th>
                                        <th>Loan Product</th>
                                        <th>Amount (UGX)</th>
                                        <th>Interest</th>
                                        <th>Total (UGX)</th>
                                        <th>Approved Date</th>
                                        <th>Days Since Approval</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loan in approved_loans %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="loan_ids" value="{{ loan.id }}" 
                                                   class="loan-checkbox" onchange="updateSelectedCount()">
                                        </td>
                                        <td>
                                            <strong>{{ loan.application_number }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ loan.id }}</small>
                                        </td>
                                        <td>
                                            <strong>{{ loan.client_account.full_account_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ loan.client_account.phone_number|default:"No phone" }}</small>
                                        </td>
                                        <td>{{ loan.loan_product.name }}</td>
                                        <td class="text-end">{{ loan.loan_amount|floatformat:2 }}</td>
                                        <td class="text-end">{{ loan.interest_amount|floatformat:2 }}</td>
                                        <td class="text-end">
                                            <strong>{{ loan.total_amount|floatformat:2 }}</strong>
                                        </td>
                                        <td>
                                            {% if loan.approval_date %}
                                                {{ loan.approval_date|date:"Y-m-d" }}
                                            {% else %}
                                                <span class="text-danger">Not approved</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if loan.approval_date %}
                                                {{ loan.approval_date|timesince }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center py-4">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No approved loans available for disbursement
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-secondary">
                                        <td colspan="4" class="text-end"><strong>Selected Totals:</strong></td>
                                        <td id="selectedLoanAmount" class="text-end">0</td>
                                        <td id="selectedInterest" class="text-end">0</td>
                                        <td id="selectedTotal" class="text-end"><strong>0</strong></td>
                                        <td colspan="2">
                                            <span id="selectedCount">0</span> loans selected
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <strong>Transaction Reference Prefix</strong>
                                </label>
                                <input type="text" class="form-control" name="transaction_prefix" 
                                       value="DISB-" placeholder="e.g., DISB-">
                                <small class="form-text text-muted">
                                    Each loan will get a unique reference: PREFIX + loan number
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <strong>Disbursement Notes</strong>
                                </label>
                                <textarea class="form-control" name="disbursement_notes" rows="2" 
                                          placeholder="General notes for all disbursements..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" onclick="clearAllSelections()">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                            <button type="submit" class="btn btn-success" id="disburseBtn" disabled>
                                <i class="fas fa-money-check-alt"></i> Disburse Selected Loans
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Upload CSV Tab -->
                <div class="tab-pane fade" id="upload" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <form method="POST" enctype="multipart/form-data" action="{% url 'loans:upload_bulk_disbursement' %}">
                                {% csrf_token %}
                                
                                <div class="mb-4">
                                    <label for="csvFile" class="form-label">
                                        <strong>Select CSV File</strong>
                                    </label>
                                    <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                                    <small class="form-text text-muted">
                                        Upload CSV with loan application numbers to disburse
                                    </small>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <strong>Disbursement Date</strong>
                                        </label>
                                        <input type="date" class="form-control" name="disbursement_date" 
                                               value="{{ today|date:'Y-m-d' }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <strong>Disbursement Method</strong>
                                        </label>
                                        <select class="form-select" name="disbursement_method" required>
                                            <option value="CASH">Cash</option>
                                            <option value="BANK_TRANSFER">Bank Transfer</option>
                                            <option value="MOBILE_MONEY">Mobile Money</option>
                                            <option value="CHEQUE">Cheque</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label">
                                        <strong>Transaction Reference Prefix</strong>
                                    </label>
                                    <input type="text" class="form-control" name="transaction_prefix" 
                                           value="DISB-" required>
                                </div>
                                
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="validateOnly" name="validate_only" checked>
                                    <label class="form-check-label" for="validateOnly">
                                        Validate only (don't disburse loans)
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Check to validate the file first without disbursing
                                    </small>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="reset" class="btn btn-secondary">
                                        <i class="fas fa-redo"></i> Clear
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-upload"></i> Process Upload
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">CSV Format Requirements</h6>
                                </div>
                                <div class="card-body">
                                    <h6>Required Column:</h6>
                                    <ul class="small mb-3">
                                        <li><code>loan_application_number</code> (e.g., AN1234)</li>
                                    </ul>
                                    
                                    <h6>Optional Columns:</h6>
                                    <ul class="small mb-3">
                                        <li><code>transaction_reference</code> (if blank, auto-generated)</li>
                                        <li><code>disbursement_notes</code> (specific notes for this loan)</li>
                                    </ul>
                                    
                                    <h6>Example CSV:</h6>
                                    <pre class="bg-light p-2 small">loan_application_number,transaction_reference,disbursement_notes
AN1234,DISB-001,First disbursement
AN5678,DISB-002,Second disbursement
AN9012,,Third disbursement</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Template Download Tab -->
                <div class="tab-pane fade" id="template" role="tabpanel">
                    <div class="text-center py-5">
                        <i class="fas fa-file-csv fa-4x text-success mb-4"></i>
                        <h4>Download CSV Template</h4>
                        <p class="mb-4">Download the template file to ensure your CSV is formatted correctly.</p>
                        
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Template Options</h5>
                                        <div class="d-grid gap-3">
                                            <a href="{% url 'loans:download_disbursement_template' %}?type=simple" class="btn btn-outline-success">
                                                <i class="fas fa-download"></i> Simple Template (1 column)
                                            </a>
                                            <a href="{% url 'loans:download_disbursement_template' %}?type=detailed" class="btn btn-outline-primary">
                                                <i class="fas fa-download"></i> Detailed Template (all columns)
                                            </a>
                                            <a href="{% url 'loans:download_disbursement_template' %}?type=sample" class="btn btn-outline-info">
                                                <i class="fas fa-download"></i> Sample Data (with example)
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-start">
                            <h5>Instructions:</h5>
                            <ol>
                                <li>Download the template that fits your needs</li>
                                <li>List the loan application numbers to disburse</li>
                                <li>Add transaction references if needed</li>
                                <li>Save as CSV file</li>
                                <li>Upload using the "Upload CSV" tab</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Disbursements -->
    {% if recent_disbursements %}
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-history"></i> Recent Disbursements (Last 10)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Loan #</th>
                            <th>Client</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>Disbursed By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loan in recent_disbursements %}
                        <tr>
                            <td>{{ loan.disbursement_date|date:"Y-m-d" }}</td>
                            <td>{{ loan.application_number }}</td>
                            <td>{{ loan.client_account.full_account_name|truncatechars:20 }}</td>
                            <td>{{ loan.disbursed_amount|floatformat:2 }}</td>
                            <td>
                                {% if loan.transaction_reference %}
                                <span class="badge bg-secondary">{{ loan.transaction_reference|truncatechars:10 }}</span>
                                {% else %}
                                <span class="badge bg-light text-dark">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if loan.disbursement_method %}
                                <span class="badge bg-info">{{ loan.disbursement_method }}</span>
                                {% else %}
                                <span class="badge bg-light text-dark">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ loan.disbursed_by.username }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript for Bulk Disbursement -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
});

function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.loan-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

function clearAllSelections() {
    const checkboxes = document.querySelectorAll('.loan-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.loan-checkbox');
    const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
    
    let totalLoanAmount = 0;
    let totalInterest = 0;
    let totalAmount = 0;
    
    // Calculate totals for selected loans
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row) {
            const loanAmount = parseFloat(row.cells[4].textContent.replace(/,/g, '')) || 0;
            const interestAmount = parseFloat(row.cells[5].textContent.replace(/,/g, '')) || 0;
            const total = parseFloat(row.cells[6].textContent.replace(/,/g, '')) || 0;
            
            totalLoanAmount += loanAmount;
            totalInterest += interestAmount;
            totalAmount += total;
        }
    });
    
    // Update display
    document.getElementById('selectedCount').textContent = selectedCheckboxes.length;
    document.getElementById('selectedLoanAmount').textContent = totalLoanAmount.toLocaleString();
    document.getElementById('selectedInterest').textContent = totalInterest.toLocaleString();
    document.getElementById('selectedTotal').textContent = totalAmount.toLocaleString();
    
    // Enable/disable submit button
    const disburseBtn = document.getElementById('disburseBtn');
    if (selectedCheckboxes.length > 0) {
        disburseBtn.disabled = false;
        disburseBtn.innerHTML = `<i class="fas fa-money-check-alt"></i> Disburse ${selectedCheckboxes.length} Loans (${totalAmount.toLocaleString()} UGX)`;
    } else {
        disburseBtn.disabled = true;
        disburseBtn.innerHTML = `<i class="fas fa-money-check-alt"></i> Disburse Selected Loans`;
    }
}

// Confirm before disbursing
document.querySelector('form').addEventListener('submit', function(e) {
    const selectedCount = document.querySelectorAll('.loan-checkbox:checked').length;
    if (selectedCount === 0) {
        e.preventDefault();
        alert('Please select at least one loan to disburse.');
        return;
    }
    
    const totalAmount = parseFloat(document.getElementById('selectedTotal').textContent.replace(/,/g, '')) || 0;
    
    if (!confirm(`Are you sure you want to disburse ${selectedCount} loans totaling ${totalAmount.toLocaleString()} UGX?\n\nThis action cannot be undone.`)) {
        e.preventDefault();
    }
});

// Tab switching
document.getElementById('upload-tab').addEventListener('shown.bs.tab', function() {
    // Reset file input when switching to upload tab
    document.getElementById('csvFile').value = '';
});
</script>

<style>
.loan-checkbox {
    transform: scale(1.2);
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.table tbody tr.selected {
    background-color: rgba(40, 167, 69, 0.1);
}

#disburseBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.nav-tabs .nav-link {
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    font-weight: bold;
    background-color: #f8f9fa;
    border-bottom-color: #f8f9fa;
}

.text-end {
    text-align: right;
}
</style>
{% endblock %}