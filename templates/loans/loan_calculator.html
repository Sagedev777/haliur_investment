{% extends 'loans/base.html' %}
{% load humanize %}

{% block title %}Loan Calculator{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'loans:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Loan Calculator</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="h2 mb-0">Loan Calculator</h1>
            <p class="text-muted mb-0">Calculate loan payments and repayment schedules</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Calculator Form -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Loan Parameters</h5>
            </div>
            <div class="card-body">
                <form method="post" id="calculator-form">
                    {% csrf_token %}

                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.loan_amount.id_for_label }}" class="form-label">
                                Loan Amount (UGX)
                            </label>
                            {{ form.loan_amount }}
                            {% if form.loan_amount.errors %}
                                <div class="text-danger small">{{ form.loan_amount.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.interest_rate.id_for_label }}" class="form-label">
                                Annual Interest Rate (%)
                            </label>
                            {{ form.interest_rate }}
                            {% if form.interest_rate.errors %}
                                <div class="text-danger small">{{ form.interest_rate.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.term_days.id_for_label }}" class="form-label">
                                Loan Term (Days)
                            </label>
                            {{ form.term_days }}
                            {% if form.term_days.errors %}
                                <div class="text-danger small">{{ form.term_days.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.interest_type.id_for_label }}" class="form-label">
                                Interest Type
                            </label>
                            {{ form.interest_type }}
                            {% if form.interest_type.errors %}
                                <div class="text-danger small">{{ form.interest_type.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.calculation_method.id_for_label }}" class="form-label">
                                Calculation Method
                            </label>
                            {{ form.calculation_method }}
                            {% if form.calculation_method.errors %}
                                <div class="text-danger small">{{ form.calculation_method.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-calculator me-2"></i>Calculate Loan
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Calculation Results -->
    <div class="col-lg-6">
        {% if calculation %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Calculation Results</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-primary mb-1">UGX {{ calculation.principal|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">Principal Amount</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-info mb-1">{{ calculation.annual_rate }}%</h4>
                            <small class="text-muted">Annual Interest Rate</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-warning mb-1">{{ calculation.term_days }}</h4>
                            <small class="text-muted">Term (Days)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-danger mb-1">UGX {{ calculation.total_interest|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">Total Interest</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-success mb-1">UGX {{ calculation.total_repayment|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">Total Repayment</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-secondary mb-1">{{ calculation.installments }}</h4>
                            <small class="text-muted">Number of Installments</small>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Installment Amount:</strong>
                            <span class="h5 text-primary ms-2">UGX {{ calculation.installment_amount|floatformat:0|intcomma }}</span>
                            <small class="text-muted d-block">per installment</small>
                        </div>
                    </div>
                </div>

                <!-- Repayment Schedule -->
                <div class="mt-4">
                    <h6 class="mb-3">Repayment Schedule</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Installment</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for installment in calculation.schedule %}
                                <tr>
                                    <td>{{ installment.installment }}</td>
                                    <td>{{ installment.due_date|date:"M d, Y" }}</td>
                                    <td>UGX {{ installment.amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-4">
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>Print
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-success w-100" onclick="downloadSchedule()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-calculator fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Enter loan parameters</h5>
                <p class="text-muted">Fill out the form to calculate loan payments and view the repayment schedule.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Calculator Presets -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Quick Calculator Presets</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary w-100 preset-btn"
                        data-amount="500000" data-rate="24" data-days="30">
                    <div class="fw-bold">UGX 500K</div>
                    <small>30 days @ 24%</small>
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary w-100 preset-btn"
                        data-amount="1000000" data-rate="20" data-days="60">
                    <div class="fw-bold">UGX 1M</div>
                    <small>60 days @ 20%</small>
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary w-100 preset-btn"
                        data-amount="2000000" data-rate="18" data-days="90">
                    <div class="fw-bold">UGX 2M</div>
                    <small>90 days @ 18%</small>
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary w-100 preset-btn"
                        data-amount="5000000" data-rate="15" data-days="180">
                    <div class="fw-bold">UGX 5M</div>
                    <small>180 days @ 15%</small>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Quick preset buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const amount = this.dataset.amount;
        const rate = this.dataset.rate;
        const days = this.dataset.days;

        document.getElementById('{{ form.loan_amount.id_for_label }}').value = amount;
        document.getElementById('{{ form.interest_rate.id_for_label }}').value = rate;
        document.getElementById('{{ form.term_days.id_for_label }}').value = days;

        // Submit the form
        document.getElementById('calculator-form').submit();
    });
});

// Download schedule function
function downloadSchedule() {
    // Simple implementation - could be enhanced to generate CSV/PDF
    const table = document.querySelector('.table');
    if (table) {
        let csv = [];
        const rows = table.querySelectorAll('tr');

        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll('td, th');

            for (let j = 0; j < cols.length; j++) {
                row.push('"' + cols[j].innerText + '"');
            }

            csv.push(row.join(','));
        }

        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'loan_schedule.csv';
        a.click();

        window.URL.revokeObjectURL(url);
    }
}
</script>

<style>
.preset-btn {
    transition: all 0.2s;
}

.preset-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.border-top-primary {
    border-top: 4px solid #007bff !important;
}

.border-top-success {
    border-top: 4px solid #28a745 !important;
}

.border-top-warning {
    border-top: 4px solid #ffc107 !important;
}

.border-top-danger {
    border-top: 4px solid #dc3545 !important;
}
</style>
{% endblock %}
