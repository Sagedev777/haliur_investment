{% extends 'base.html' %}

{% block title %}Edit Account - {{ account.account_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'accounts:account_list' %}">Accounts</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'accounts:account_detail' account.pk %}">{{ account.account_number }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Edit Client Account: {{ account.account_number }}</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="editAccountForm">
                        {% csrf_token %}
                        
                        <!-- Account Type (Read-only) -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Account Type</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Account Type</label>
                                        <input type="text" class="form-control" value="{{ account.get_account_type_display }}" readonly>
                                        <input type="hidden" name="account_type" value="{{ account.account_type }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Account Status</label>
                                        <input type="text" class="form-control" value="{{ account.get_account_status_display }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Primary Account Holder -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Primary Account Holder</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_first_name" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="person1_first_name" name="person1_first_name" 
                                               value="{{ account.person1_first_name }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_last_name" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="person1_last_name" name="person1_last_name" 
                                               value="{{ account.person1_last_name }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_contact" class="form-label">Contact Number *</label>
                                        <input type="text" class="form-control" id="person1_contact" name="person1_contact" 
                                               value="{{ account.person1_contact }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_nin" class="form-label">NIN *</label>
                                        <input type="text" class="form-control" id="person1_nin" name="person1_nin" 
                                               value="{{ account.person1_nin }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_gender" class="form-label">Gender *</label>
                                        <select class="form-select" id="person1_gender" name="person1_gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="M" {% if account.person1_gender == 'M' %}selected{% endif %}>Male</option>
                                            <option value="F" {% if account.person1_gender == 'F' %}selected{% endif %}>Female</option>
                                            <option value="O" {% if account.person1_gender == 'O' %}selected{% endif %}>Other</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label for="person1_address" class="form-label">Address *</label>
                                        <textarea class="form-control" id="person1_address" name="person1_address" rows="2" required>{{ account.person1_address }}</textarea>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_area_code" class="form-label">Area Code *</label>
                                        <input type="text" class="form-control" id="person1_area_code" name="person1_area_code" 
                                               value="{{ account.person1_area_code }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person1_next_of_kin" class="form-label">Next of Kin *</label>
                                        <input type="text" class="form-control" id="person1_next_of_kin" name="person1_next_of_kin" 
                                               value="{{ account.person1_next_of_kin }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Joint Account Holder (if applicable) -->
                        {% if account.account_type == 'JOINT' %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Joint Account Holder</h5>
                            </div>
                            <div class="card-body">
                                {% if account.person2_client %}
                                    <div class="alert alert-info">
                                        <p><strong>Linked to existing client:</strong> {{ account.person2_client.full_account_name }} ({{ account.person2_client.account_number }})</p>
                                        <p>To change the linked client, select a new one below:</p>
                                    </div>
                                {% endif %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_client" class="form-label">Link to Existing Client</label>
                                        <select class="form-select" id="person2_client" name="person2_client">
                                            <option value="">Select Existing Client</option>
                                            {% for active_account in active_accounts %}
                                                <option value="{{ active_account.pk }}" 
                                                    {% if account.person2_client_id == active_account.pk %}selected{% endif %}>
                                                    {{ active_account.account_number }} - {{ active_account.full_account_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">If you select an existing client, their details will be used automatically.</div>
                                    </div>
                                </div>

                                <hr>
                                <h6>Or Enter Joint Holder Details Manually:</h6>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_first_name" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="person2_first_name" name="person2_first_name" 
                                               value="{{ account.person2_first_name|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_last_name" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="person2_last_name" name="person2_last_name" 
                                               value="{{ account.person2_last_name|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_contact" class="form-label">Contact Number</label>
                                        <input type="text" class="form-control" id="person2_contact" name="person2_contact" 
                                               value="{{ account.person2_contact|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_nin" class="form-label">NIN</label>
                                        <input type="text" class="form-control" id="person2_nin" name="person2_nin" 
                                               value="{{ account.person2_nin|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_gender" class="form-label">Gender</label>
                                        <select class="form-select" id="person2_gender" name="person2_gender">
                                            <option value="">Select Gender</option>
                                            <option value="M" {% if account.person2_gender == 'M' %}selected{% endif %}>Male</option>
                                            <option value="F" {% if account.person2_gender == 'F' %}selected{% endif %}>Female</option>
                                            <option value="O" {% if account.person2_gender == 'O' %}selected{% endif %}>Other</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label for="person2_address" class="form-label">Address</label>
                                        <textarea class="form-control" id="person2_address" name="person2_address" rows="2">{{ account.person2_address|default:'' }}</textarea>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_area_code" class="form-label">Area Code</label>
                                        <input type="text" class="form-control" id="person2_area_code" name="person2_area_code" 
                                               value="{{ account.person2_area_code|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="person2_next_of_kin" class="form-label">Next of Kin</label>
                                        <input type="text" class="form-control" id="person2_next_of_kin" name="person2_next_of_kin" 
                                               value="{{ account.person2_next_of_kin|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Business Information -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Business Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="business_location" class="form-label">Business Location *</label>
                                        <input type="text" class="form-control" id="business_location" name="business_location" 
                                               value="{{ account.business_location }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="business_sector" class="form-label">Business Sector *</label>
                                        <input type="text" class="form-control" id="business_sector" name="business_sector" 
                                               value="{{ account.business_sector }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Savings Information (Read-only) -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Savings Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Current Balance</label>
                                        <input type="text" class="form-control" value="${{ account.savings_balance }}" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Total Deposited</label>
                                        <input type="text" class="form-control" value="${{ account.total_savings_deposited }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'accounts:account_detail' account.pk %}" class="btn btn-secondary me-2">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Important Notes -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Important Notes</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        {% if user_role == 'ADMIN' %}
                            <li>As an <strong>Admin</strong>, your changes will be applied immediately.</li>
                        {% else %}
                            <li>As <strong>{{ user_role }}</strong>, your changes will be submitted as an edit request for admin approval.</li>
                            <li>The account will remain unchanged until an admin approves your request.</li>
                        {% endif %}
                        <li>An audit log entry will be created for all changes.</li>
                        <li>Required fields are marked with *</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle existing client selection for joint accounts
    const person2ClientSelect = document.getElementById('person2_client');
    if (person2ClientSelect) {
        person2ClientSelect.addEventListener('change', function() {
            const manualFields = ['person2_first_name', 'person2_last_name', 'person2_contact', 
                                  'person2_nin', 'person2_gender', 'person2_address', 
                                  'person2_area_code', 'person2_next_of_kin'];
            
            if (this.value) {
                // Disable manual fields when existing client is selected
                manualFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = true;
                        field.required = false;
                    }
                });
            } else {
                // Enable manual fields when no existing client is selected
                manualFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = false;
                        // Only make required if account is joint
                        if (field.type !== 'select-one') {
                            field.required = true;
                        }
                    }
                });
            }
        });
        
        // Trigger change event on page load
        person2ClientSelect.dispatchEvent(new Event('change'));
    }
    
    // Form validation
    const form = document.getElementById('editAccountForm');
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        // Check required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim() && !field.disabled) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            event.preventDefault();
            alert('Please fill in all required fields.');
        }
    });
});
</script>

{% endblock %}